!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("./dist/index",[],t):"object"==typeof exports?exports["./dist/index"]=t():e["./dist/index"]=t()}(global,function(){return function(e){var t={};function o(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,o),n.l=!0,n.exports}return o.m=e,o.c=t,o.d=function(e,t,r){o.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},o.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=7)}([function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AsyncCounter=t.oncePerKey=t.isValidDate=t.bootstrapKoaApp=void 0;var r=i(o(11)),n=i(o(10)),a=i(o(9)),s=i(o(8));function i(e){return e&&e.__esModule?e:{default:e}}t.bootstrapKoaApp=(()=>{const e=new r.default,t=new a.default;return e.use((0,n.default)()),e.use(async(e,t)=>t().catch(t=>{console.dir(t),e.body=String(t),e.status=t.status||500})),e.use((0,s.default)({onerror(e,t){t.throw(400,`cannot parse request body, ${JSON.stringify(e)}`)}})),e.use(t.routes()),{app:e,router:t}});t.isValidDate=(e=>"[object Date]"===Object.prototype.toString.call(e)&&!isNaN(e.getTime()));const c=((e={})=>t=>(o,r)=>()=>{o in e||(e[o]=0),e[o]<t&&(r(),e[o]++)})()(1);t.oncePerKey=c;t.AsyncCounter=class{constructor(e){let t=0;this.countTimes=e,this.ready=new Promise(o=>{this.finished=new Promise(r=>{this.count=(()=>this.ready.then(()=>(()=>(++t===e&&r(),t))())),o()})})}}},function(e,t){e.exports=require("../settings")},function(e,t){e.exports=require("request-promise")},function(e,t){e.exports=require("pythonic")},function(e,t){e.exports=require("querystring")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defineJob=t.jobAssertions=t.jobOperations=t.promiseJobOperation=void 0;var r=c(o(4)),n=o(3),a=c(o(2)),s=c(o(1)),i=o(0);function c(e){return e&&e.__esModule?e:{default:e}}function u(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}const l=Symbol("util.promisify.custom"),d=Symbol("customPromisifyArgs");function f(e){let t;if("function"!=typeof e)throw new errors.TypeError("ERR_INVALID_ARG_TYPE","original","Function");if(e[l]){const t=e[l];if("function"!=typeof t)throw new errors.TypeError("ERR_INVALID_ARG_TYPE","util.promisify.custom","Function",t);return Object.defineProperty(t,l,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}const o=e[d];function r(...r){return new Promise(function(n,a){try{e.call(t||this,...r,(e,...t)=>{if(e)a(e);else if(void 0!==o&&t.length>1){const e={};for(var r=0;r<o.length;r++)e[o[r]]=t[r];n(e)}else n(t[0])})}catch(e){a(e)}})}return Object.setPrototypeOf(r,Object.getPrototypeOf(e)),Object.defineProperty(r,"bind",{value:e=>(t=e,r),enumerable:!1,writable:!1,configurable:!0}),Object.defineProperty(r,l,{value:r,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(r,Object.getOwnPropertyDescriptors(e))}f.custom=l;const p=(e,t={})=>o=>{if(!o.name||e&&!o[e])throw new Error(`expected request body to match {name${e?`, ${e}`:""}}`);return function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},r=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(o).filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable}))),r.forEach(function(t){u(e,t,o[t])})}return e}({},t,o)},b=(e,t)=>async(o,r)=>r.count({name:o.name}).then(r=>{if(!e(r))throw new Error(t(o.name))}),y={alreadyExists:b(e=>e>0,e=>`Did not find a job named "${e}"`),notExists:b(e=>e<=0,e=>`A job named "${e}" already exist`),doNotAssert:()=>!0};t.jobAssertions=y;const m=async(e,t,o)=>{const{name:i,url:c,method:u,callback:l}=e;return o.define(i,(e,t)=>{const{attrs:{data:o}}=e;let i=c;for(const[e,t]of(0,n.keyValues)(o.params))i=i.replace(`:${e}`,t);const d=r.default.stringify(o.query);""!==d&&(i+=`?${d}`),Promise.race([new Promise((e,t)=>setTimeout(()=>t(new Error("TimeOutError")),s.default.timeout)),(0,a.default)({method:u||"POST",uri:i,body:o.body,headers:o.headers||{},json:!0})]).catch(t=>(e.fail(t.message),{error:t.message})).then(e=>{if(l)return(0,a.default)({method:l.method||"POST",uri:l.url,headers:l.headers||{},body:{data:o,response:e},json:!0})}).catch(t=>e.fail(`failure in callback: ${t.message}`)).then(()=>t())}),await t.count({name:i}).then(o=>o<1?t.insert(e):t.update({name:i},{$set:e})),"job defined"};t.defineJob=m;const j={now:{fn:e=>f(e.now).bind(e),message:"for now",getParams:e=>[e.name,e.data]},once:{fn:e=>f(e.schedule).bind(e),message:"for once",getParams:e=>{let t=parseInt(e.interval,10);return t=isNaN(t)?e.interval:t,t=new Date(t),[t=(0,i.isValidDate)(t)?t:e.interval,e.name,e.data]}},every:{fn:e=>f(e.every).bind(e),message:"for repetition",getParams:e=>[e.interval,e.name,e.data]}},w=e=>async(t,o,r)=>(await e.fn(r)(...e.getParams(t)),`job scheduled ${e.message}`),g=(e,t)=>({check:e,fn:t}),h={create:g(p("url"),m),update:g(p(),m),delete:g(p(),async(e,t,o)=>{const r=f(o.cancel).bind(o),n=await r(e);return`removed ${(await t.remove(e)).result.n} job definitions and ${n} job instances.`}),cancel:g(e=>e,async(e,t,o)=>{return`${await f(o.cancel).bind(o)(e)} jobs canceled`}),now:g(p(!1,{data:{body:{},params:{},query:{}}}),w(j.now)),once:g(p("interval",{data:{body:{},params:{},query:{}}}),w(j.once)),every:g(p("interval",{data:{body:{},params:{},query:{}}}),w(j.every))};t.jobOperations=h;t.promiseJobOperation=(async(e,t,o,r,n)=>(e=await n.check(e),await r(e,t),n.fn(e,t,o)))},function(e,t){e.exports=require("agenda")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=t.jobsReady=t.agenda=t.router=t.app=void 0;var r=i(o(6)),n=i(o(1)),a=o(0),s=o(5);function i(e){return e&&e.__esModule?e:{default:e}}const c=Symbol("util.promisify.custom"),u=Symbol("customPromisifyArgs");function l(e){let t;if("function"!=typeof e)throw new errors.TypeError("ERR_INVALID_ARG_TYPE","original","Function");if(e[c]){const t=e[c];if("function"!=typeof t)throw new errors.TypeError("ERR_INVALID_ARG_TYPE","util.promisify.custom","Function",t);return Object.defineProperty(t,c,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}const o=e[u];function r(...r){return new Promise(function(n,a){try{e.call(t||this,...r,(e,...t)=>{if(e)a(e);else if(void 0!==o&&t.length>1){const e={};for(var r=0;r<o.length;r++)e[o[r]]=t[r];n(e)}else n(t[0])})}catch(e){a(e)}})}return Object.setPrototypeOf(r,Object.getPrototypeOf(e)),Object.defineProperty(r,"bind",{value:e=>(t=e,r),enumerable:!1,writable:!1,configurable:!0}),Object.defineProperty(r,c,{value:r,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(r,Object.getOwnPropertyDescriptors(e))}l.custom=c;const{app:d,router:f}=(0,a.bootstrapKoaApp)();t.router=f,t.app=d;const p=new r.default({db:{address:n.default.agendaMongoUrl,collection:n.default.collection}});t.agenda=p;const b=l(p.on).bind(p)("ready").then(async()=>{const e=p._mdb.collection(n.default.definitions);return e.toArray=(()=>{const t=e.find();return l(t.toArray).bind(t)()}),await e.toArray().then(t=>Promise.all(t.map(t=>(0,s.defineJob)(t,e,p)))),p.start(),e});t.jobsReady=b;const y=(e,t,o=400)=>async(r,n)=>{const a=r.request.body||{};a.name=r.params.jobName||a.name;const i=await b;r.body=await(0,s.promiseJobOperation)(a,i,p,e,t).catch(e=>r.throw(o,e)),await n()};f.get("/api/job",async(e,t)=>{e.body=await b.then(e=>e.toArray()),await t()}),f.post("/api/job",y(s.jobAssertions.notExists,s.jobOperations.create)),f.del("/api/job/:jobName",y(s.jobAssertions.alreadyExists,s.jobOperations.delete)),f.put("/api/job/:jobName",y(s.jobAssertions.alreadyExists,s.jobOperations.update)),f.post("/api/job/once",y(s.jobAssertions.alreadyExists,s.jobOperations.once)),f.post("/api/job/every",y(s.jobAssertions.alreadyExists,s.jobOperations.every)),f.post("/api/job/now",y(s.jobAssertions.alreadyExists,s.jobOperations.now)),f.post("/api/job/cancel",y(s.jobAssertions.doNotAssert,s.jobOperations.cancel));const m=()=>{console.log("\nShutting down gracefully..."),p.stop(()=>{process.exit(0)})};process.on("SIGTERM",m),process.on("SIGINT",m);var j=d;t.default=j},function(e,t){e.exports=require("koa-bodyparser")},function(e,t){e.exports=require("koa-router")},function(e,t){e.exports=require("koa-logger")},function(e,t){e.exports=require("koa")}])});
//# sourceMappingURL=index.js.map