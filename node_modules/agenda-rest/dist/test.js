!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("./dist/test",[],t):"object"==typeof exports?exports["./dist/test"]=t():e["./dist/test"]=t()}(global,function(){return function(e){var t={};function o(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,o),r.l=!0,r.exports}return o.m=e,o.c=t,o.d=function(e,t,n){o.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},o.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},o.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(t,"a",t),t},o.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o.p="",o(o.s=14)}([function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AsyncCounter=t.oncePerKey=t.isValidDate=t.bootstrapKoaApp=void 0;var n=a(o(11)),r=a(o(10)),s=a(o(9)),i=a(o(8));function a(e){return e&&e.__esModule?e:{default:e}}t.bootstrapKoaApp=(()=>{const e=new n.default,t=new s.default;return e.use((0,r.default)()),e.use(async(e,t)=>t().catch(t=>{console.dir(t),e.body=String(t),e.status=t.status||500})),e.use((0,i.default)({onerror(e,t){t.throw(400,`cannot parse request body, ${JSON.stringify(e)}`)}})),e.use(t.routes()),{app:e,router:t}});t.isValidDate=(e=>"[object Date]"===Object.prototype.toString.call(e)&&!isNaN(e.getTime()));const c=((e={})=>t=>(o,n)=>()=>{o in e||(e[o]=0),e[o]<t&&(n(),e[o]++)})()(1);t.oncePerKey=c;t.AsyncCounter=class{constructor(e){let t=0;this.countTimes=e,this.ready=new Promise(o=>{this.finished=new Promise(n=>{this.count=(()=>this.ready.then(()=>(()=>(++t===e&&n(),t))())),o()})})}}},function(e,t){e.exports=require("../settings")},function(e,t){e.exports=require("request-promise")},function(e,t){e.exports=require("pythonic")},function(e,t){e.exports=require("querystring")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.defineJob=t.jobAssertions=t.jobOperations=t.promiseJobOperation=void 0;var n=c(o(4)),r=o(3),s=c(o(2)),i=c(o(1)),a=o(0);function c(e){return e&&e.__esModule?e:{default:e}}function u(e,t,o){return t in e?Object.defineProperty(e,t,{value:o,enumerable:!0,configurable:!0,writable:!0}):e[t]=o,e}const l=Symbol("util.promisify.custom"),f=Symbol("customPromisifyArgs");function d(e){let t;if("function"!=typeof e)throw new errors.TypeError("ERR_INVALID_ARG_TYPE","original","Function");if(e[l]){const t=e[l];if("function"!=typeof t)throw new errors.TypeError("ERR_INVALID_ARG_TYPE","util.promisify.custom","Function",t);return Object.defineProperty(t,l,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}const o=e[f];function n(...n){return new Promise(function(r,s){try{e.call(t||this,...n,(e,...t)=>{if(e)s(e);else if(void 0!==o&&t.length>1){const e={};for(var n=0;n<o.length;n++)e[o[n]]=t[n];r(e)}else r(t[0])})}catch(e){s(e)}})}return Object.setPrototypeOf(n,Object.getPrototypeOf(e)),Object.defineProperty(n,"bind",{value:e=>(t=e,n),enumerable:!1,writable:!1,configurable:!0}),Object.defineProperty(n,l,{value:n,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(n,Object.getOwnPropertyDescriptors(e))}d.custom=l;const p=(e,t={})=>o=>{if(!o.name||e&&!o[e])throw new Error(`expected request body to match {name${e?`, ${e}`:""}}`);return function(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{},n=Object.keys(o);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(o).filter(function(e){return Object.getOwnPropertyDescriptor(o,e).enumerable}))),n.forEach(function(t){u(e,t,o[t])})}return e}({},t,o)},b=(e,t)=>async(o,n)=>n.count({name:o.name}).then(n=>{if(!e(n))throw new Error(t(o.name))}),y={alreadyExists:b(e=>e>0,e=>`Did not find a job named "${e}"`),notExists:b(e=>e<=0,e=>`A job named "${e}" already exist`),doNotAssert:()=>!0};t.jobAssertions=y;const m=async(e,t,o)=>{const{name:a,url:c,method:u,callback:l}=e;return o.define(a,(e,t)=>{const{attrs:{data:o}}=e;let a=c;for(const[e,t]of(0,r.keyValues)(o.params))a=a.replace(`:${e}`,t);const f=n.default.stringify(o.query);""!==f&&(a+=`?${f}`),Promise.race([new Promise((e,t)=>setTimeout(()=>t(new Error("TimeOutError")),i.default.timeout)),(0,s.default)({method:u||"POST",uri:a,body:o.body,headers:o.headers||{},json:!0})]).catch(t=>(e.fail(t.message),{error:t.message})).then(e=>{if(l)return(0,s.default)({method:l.method||"POST",uri:l.url,headers:l.headers||{},body:{data:o,response:e},json:!0})}).catch(t=>e.fail(`failure in callback: ${t.message}`)).then(()=>t())}),await t.count({name:a}).then(o=>o<1?t.insert(e):t.update({name:a},{$set:e})),"job defined"};t.defineJob=m;const j={now:{fn:e=>d(e.now).bind(e),message:"for now",getParams:e=>[e.name,e.data]},once:{fn:e=>d(e.schedule).bind(e),message:"for once",getParams:e=>{let t=parseInt(e.interval,10);return t=isNaN(t)?e.interval:t,t=new Date(t),[t=(0,a.isValidDate)(t)?t:e.interval,e.name,e.data]}},every:{fn:e=>d(e.every).bind(e),message:"for repetition",getParams:e=>[e.interval,e.name,e.data]}},w=e=>async(t,o,n)=>(await e.fn(n)(...e.getParams(t)),`job scheduled ${e.message}`),h=(e,t)=>({check:e,fn:t}),g={create:h(p("url"),m),update:h(p(),m),delete:h(p(),async(e,t,o)=>{const n=d(o.cancel).bind(o),r=await n(e);return`removed ${(await t.remove(e)).result.n} job definitions and ${r} job instances.`}),cancel:h(e=>e,async(e,t,o)=>{return`${await d(o.cancel).bind(o)(e)} jobs canceled`}),now:h(p(!1,{data:{body:{},params:{},query:{}}}),w(j.now)),once:h(p("interval",{data:{body:{},params:{},query:{}}}),w(j.once)),every:h(p("interval",{data:{body:{},params:{},query:{}}}),w(j.every))};t.jobOperations=g;t.promiseJobOperation=(async(e,t,o,n,r)=>(e=await r.check(e),await n(e,t),r.fn(e,t,o)))},function(e,t){e.exports=require("agenda")},function(e,t,o){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=t.jobsReady=t.agenda=t.router=t.app=void 0;var n=a(o(6)),r=a(o(1)),s=o(0),i=o(5);function a(e){return e&&e.__esModule?e:{default:e}}const c=Symbol("util.promisify.custom"),u=Symbol("customPromisifyArgs");function l(e){let t;if("function"!=typeof e)throw new errors.TypeError("ERR_INVALID_ARG_TYPE","original","Function");if(e[c]){const t=e[c];if("function"!=typeof t)throw new errors.TypeError("ERR_INVALID_ARG_TYPE","util.promisify.custom","Function",t);return Object.defineProperty(t,c,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}const o=e[u];function n(...n){return new Promise(function(r,s){try{e.call(t||this,...n,(e,...t)=>{if(e)s(e);else if(void 0!==o&&t.length>1){const e={};for(var n=0;n<o.length;n++)e[o[n]]=t[n];r(e)}else r(t[0])})}catch(e){s(e)}})}return Object.setPrototypeOf(n,Object.getPrototypeOf(e)),Object.defineProperty(n,"bind",{value:e=>(t=e,n),enumerable:!1,writable:!1,configurable:!0}),Object.defineProperty(n,c,{value:n,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(n,Object.getOwnPropertyDescriptors(e))}l.custom=c;const{app:f,router:d}=(0,s.bootstrapKoaApp)();t.router=d,t.app=f;const p=new n.default({db:{address:r.default.agendaMongoUrl,collection:r.default.collection}});t.agenda=p;const b=l(p.on).bind(p)("ready").then(async()=>{const e=p._mdb.collection(r.default.definitions);return e.toArray=(()=>{const t=e.find();return l(t.toArray).bind(t)()}),await e.toArray().then(t=>Promise.all(t.map(t=>(0,i.defineJob)(t,e,p)))),p.start(),e});t.jobsReady=b;const y=(e,t,o=400)=>async(n,r)=>{const s=n.request.body||{};s.name=n.params.jobName||s.name;const a=await b;n.body=await(0,i.promiseJobOperation)(s,a,p,e,t).catch(e=>n.throw(o,e)),await r()};d.get("/api/job",async(e,t)=>{e.body=await b.then(e=>e.toArray()),await t()}),d.post("/api/job",y(i.jobAssertions.notExists,i.jobOperations.create)),d.del("/api/job/:jobName",y(i.jobAssertions.alreadyExists,i.jobOperations.delete)),d.put("/api/job/:jobName",y(i.jobAssertions.alreadyExists,i.jobOperations.update)),d.post("/api/job/once",y(i.jobAssertions.alreadyExists,i.jobOperations.once)),d.post("/api/job/every",y(i.jobAssertions.alreadyExists,i.jobOperations.every)),d.post("/api/job/now",y(i.jobAssertions.alreadyExists,i.jobOperations.now)),d.post("/api/job/cancel",y(i.jobAssertions.doNotAssert,i.jobOperations.cancel));const m=()=>{console.log("\nShutting down gracefully..."),p.stop(()=>{process.exit(0)})};process.on("SIGTERM",m),process.on("SIGINT",m);var j=f;t.default=j},function(e,t){e.exports=require("koa-bodyparser")},function(e,t){e.exports=require("koa-router")},function(e,t){e.exports=require("koa-logger")},function(e,t){e.exports=require("koa")},function(e,t){e.exports=require("supertest")},function(e,t){e.exports=require("ava")},function(e,t,o){"use strict";const n=Symbol("util.promisify.custom"),r=Symbol("customPromisifyArgs");function s(e){let t;if("function"!=typeof e)throw new errors.TypeError("ERR_INVALID_ARG_TYPE","original","Function");if(e[n]){const t=e[n];if("function"!=typeof t)throw new errors.TypeError("ERR_INVALID_ARG_TYPE","util.promisify.custom","Function",t);return Object.defineProperty(t,n,{value:t,enumerable:!1,writable:!1,configurable:!0}),t}const o=e[r];function s(...n){return new Promise(function(r,s){try{e.call(t||this,...n,(e,...t)=>{if(e)s(e);else if(void 0!==o&&t.length>1){const e={};for(var n=0;n<o.length;n++)e[o[n]]=t[n];r(e)}else r(t[0])})}catch(e){s(e)}})}return Object.setPrototypeOf(s,Object.getPrototypeOf(e)),Object.defineProperty(s,"bind",{value:e=>(t=e,s),enumerable:!1,writable:!1,configurable:!0}),Object.defineProperty(s,n,{value:s,enumerable:!1,writable:!1,configurable:!0}),Object.defineProperties(s,Object.getOwnPropertyDescriptors(e))}s.custom=n;const i=o(13),a=o(12),{bootstrapKoaApp:c,oncePerKey:u,AsyncCounter:l}=o(0),{app:f,router:d}=c(),p=e=>e?`http://localhost:4042${e}`:"http://localhost:4042",b=a("http://localhost:4041");i.before(()=>(async()=>{const{app:e,jobsReady:t}=o(7);await s(e.listen).bind(e)(4041).then(()=>console.log("agenda-rest app running")),await s(f.listen).bind(f)(4042).then(()=>console.log("test app running")),await t})()),i.serial("POST /api/job fails without content",async e=>{const t=await b.post("/api/job").send();e.is(t.status,400)}),i.serial("POST /api/job succeeds when a job is specified",async e=>{const t=await b.post("/api/job").send({name:"foo",url:p("/fooWrong")});e.is(t.status,200)}),i.serial("PUT /api/job fails when the job does not exists",async e=>{const t=await b.put("/api/job/fooWrong").send({url:p("/foo")});e.is(t.status,400)}),i.serial("PUT /api/job succeeds when the job exists",async e=>{const t=await b.put("/api/job/foo").send({url:p("/foo")});e.is(t.status,200)});const y={},m=(e,t,o=1,n=200)=>{const r=new l(o);return y.counter=r,y.message=t,y.statusCode=n,u(e,()=>d.post(e,async(e,t)=>{e.body=y.message,e.status=y.statusCode,console.log(`${y.message}! ${await y.counter.count()} of ${y.counter.countTimes}`),await t()}))(),r};i.serial("POST /api/job/now with existing foo definition invokes the foo endpoint",async e=>{const t=m("/foo","foo now invoked"),o=await b.post("/api/job/now").send({name:"foo"});e.is(o.text,"job scheduled for now"),await t.finished}),i.serial("POST /api/job/every with existing foo definition invokes the foo endpoint",async e=>{const t=m("/foo","foo every invoked",3),o=await b.post("/api/job/every").send({name:"foo",interval:"2 seconds"});e.is(o.text,"job scheduled for repetition"),await t.finished}),i.serial("POST /api/job/once with existing foo definition invokes the foo endpoint",async e=>{const t=m("/foo","foo once invoked"),o=await b.post("/api/job/once").send({name:"foo",interval:(new Date).getTime()+1e4});e.is(o.text,"job scheduled for once"),await t.finished}),i.serial("DELETE /api/job succeeds when a job is defined",async e=>{const t=await b.delete("/api/job/foo");e.is(t.status,200)})}])});
//# sourceMappingURL=test.js.map